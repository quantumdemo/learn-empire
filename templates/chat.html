{% extends "base.html" %}

{% block title %}{{ room.name }} - Chat{% endblock %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat_theme.css') }}">
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-top-bar">
        <a href="{{ url_for('main.chat_rooms') }}" class="back-arrow">&larr;</a>
        <div class="room-name">{{ room.name }}</div>
        <a href="#" class="info-button">&#9432;</a> {# Placeholder for info page #}
    </div>

    <div class="messages-area" id="messages-area">
        <!-- Messages will be loaded here by JavaScript -->
    </div>

    <div class="chat-bottom-bar">
        <button class="icon-btn" id="media-btn" title="Send Image">üñºÔ∏è</button>
        <button class="icon-btn" id="docs-btn" title="Send Document">üìÑ</button>
        <button class="icon-btn" id="emoji-btn" title="Emoji">üòÄ</button>
        <input type="text" id="message-input" class="text-input" placeholder="Type a message...">
        <button class="icon-btn" id="mic-btn" title="Speech-to-Text">üé§</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const room_id = {{ room.id }};
    const current_user_id = {{ current_user.id }};

    const messagesArea = document.getElementById('messages-area');
    const messageInput = document.getElementById('message-input');
    const micBtn = document.getElementById('mic-btn');

    // Join the room
    socket.emit('join', { room_id: room_id });

    // Listen for new messages
    socket.on('message', function(data) {
        if (data.room_id == room_id) {
            addMessage(data);
        }
    });

    // Function to add a message to the UI
    function addMessage(data) {
        const wrapper = document.createElement('div');
        wrapper.classList.add('message-wrapper');

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');

        // Simple text content for now
        bubble.textContent = `${data.user_name}: ${data.content}`;

        if (data.user_id == current_user_id) {
            wrapper.classList.add('sender');
        } else {
            wrapper.classList.add('receiver');
        }

        wrapper.appendChild(bubble);
        messagesArea.appendChild(wrapper);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    // Send message on Enter key
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const message = messageInput.value.trim();
            if (message) {
                socket.emit('message', {
                    room_id: room_id,
                    content: message
                });
                // Add message to UI immediately for sender
                addMessage({
                    user_name: 'You',
                    user_id: current_user_id,
                    content: message
                });
                messageInput.value = '';
            }
        }
    });

    // Fetch and display message history
    fetch(`/chat/room/${room_id}/history`)
        .then(response => response.json())
        .then(history => {
            messagesArea.innerHTML = ''; // Clear loading state
            history.forEach(msg => addMessage(msg));
        });

    // --- Speech-to-Text ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onstart = function() {
            micBtn.style.color = 'red'; // Indicate recording
            micBtn.title = 'Stop Recording';
        };

        recognition.onresult = function(event) {
            let interim_transcript = '';
            let final_transcript = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    final_transcript += event.results[i][0].transcript;
                } else {
                    interim_transcript += event.results[i][0].transcript;
                }
            }
            // Append final transcript to the input, potentially with a space
            if(final_transcript) {
                 messageInput.value += final_transcript + ' ';
            }
        };

        recognition.onerror = function(event) {
            console.error('Speech recognition error', event.error);
            micBtn.style.color = 'white';
            micBtn.title = 'Speech-to-Text';
        };

        recognition.onend = function() {
            micBtn.style.color = 'white';
            micBtn.title = 'Speech-to-Text';
        };

    } else {
        micBtn.style.display = 'none'; // Hide button if API is not supported
    }

    micBtn.addEventListener('click', function() {
        if (recognition) {
            // A simple way to check if it's running
            try {
                recognition.start();
                micBtn.style.color = 'red';
            } catch(e) {
                // Throws an error if it's already started
                recognition.stop();
                micBtn.style.color = 'white';
            }
        }
    });
});
</script>
{% endblock %}
